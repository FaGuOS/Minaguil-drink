<div class="container-fluid mt-4">
  <% content_for :page_title do %>
    Comments!
  <% end %>
  <div class="row">
    <!-- 左側のユーザー情報と画像表示 -->
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-body text-center">
          <% if @post %>
            <h5 class="card-title">ユーザー名: <%= @post.user.user_name %></h5>
            <div class="mb-3">
              <%= image_tag @post.image.attached? ? url_for(@post.image) : 'Reviewonly.png', id: 'image_preview', class: 'img-thumbnail mb-2' %>
            </div>
            <div class="d-flex justify-content-around">
              <% if @post.user == current_user %>
                <div class="text-center">
                  <i class="fas fa-eye"></i>
                  <p><%= @post.view_count >= 1000000 ? 'MAX!' : number_with_delimiter(@post.view_count) %></p>
                </div>
                <div class="text-center">
                  <i class="fas fa-thumbs-up"></i>
                  <p><%= @post.yes >= 1000000 ? 'MAX!' : number_with_delimiter(@post.yes) %></p>
                </div>
                <div class="text-center">
                  <i class="fas fa-comments"></i>
                  <p><%= @post.comments.count >= 1000000 ? 'MAX!' : number_with_delimiter(@post.comments.count) %></p>
                </div>
              <% else %>
                <div class="text-center">
                  <i class="fas fa-thumbs-up yes-icon" data-post-id="<%= @post.id %>"></i>
                  <p class="yes-count"><%= @post.yes >= 1000000 ? 'MAX!' : number_with_delimiter(@post.yes) %></p>
                </div>
                <div class="text-center">
                  <i class="fas fa-bookmark bookmark-icon" data-post-id="<%= @post.id %>"></i>
                </div>
                <div class="text-center">
                  <i class="fas fa-comments"></i>
                  <%= link_to "#{@post.comments.count}件のコメント", post_comments_path(@post), class: 'comment-link' %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p>投稿が見つかりませんでした。</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- 右側のコメント一覧 -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-body">
          <h3 class="card-title">Comments</h3>
          <ul class="list-group">
            <% @comments.each do |comment| %>
              <li class="list-group-item">
                <strong><%= comment.user.user_name %>:</strong>
                <%= comment.comment_1 %> <%= comment.comment_2 %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <!-- 戻るボタン -->
      <div class="card mb-4">
        <div class="card-body text-center">
          <%= link_to 'レビューへ戻る', post_path(@post), class: 'btn btn-primary' %>
          <% unless @post.user == current_user %>
            <%= link_to 'コメントを投稿する', new_post_comment_path(@post), class: 'btn btn-secondary' %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Yesアイコンのクリックイベント
    document.querySelectorAll('.yes-icon').forEach(function(icon) {
      icon.addEventListener('click', function() {
        const postId = this.getAttribute('data-post-id');
        fetch(`/posts/${postId}/increment_yes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.yes !== undefined) {
            this.nextElementSibling.textContent = data.yes >= 1000000 ? 'MAX!' : new Intl.NumberFormat().format(data.yes);
          } else if (data.error) {
            alert(data.error);
          }
        });
      });
    });

    // ブックマークアイコンのクリックイベント
    document.querySelectorAll('.bookmark-icon').forEach(function(icon) {
      icon.addEventListener('click', function() {
        const postId = this.getAttribute('data-post-id');
        fetch(`/posts/${postId}/bookmark`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.bookmarked) {
            alert('ブックマークしました！');
          }
        });
      });
    });
  });
</script>
